# SeqRepeatPuller
SeqRepeatPuller is a versatile collection of tools designed to aggregate repeated sequences across entire genomes, not limited to humans. It enables the identification and extraction of specific genome regions based on repeated element sequences.

## Key Features
- **Whole-genome position identification (get_WG_pos):**
  - Identifies whole-genome positions of repeated elements using:
    - The sequence of the repeated element.
    - A BED file listing the repeated elements of interest.
    - A BED file with sequences of interest on the repeated elements.
    - The genome sequence of interest.

- **Sequence extraction:**
  - The main tool, SeqRepeatPuller, retrieves all sequences mapping to the identified genome positions. It supports:
    - One or multiple BAM or FASTQ files.
    - Two mappers: Bowtie2 (for classic sequences) and Bismark (for bisulfite-treated sequences, used in methylation studies).
    - Whole-genome position files generated by get_WG_pos or custom files adhering to the required column naming convention.

## Installation

### Requirements
Ensure Singularity or Apptainer is pre-installed on your computer or cluster.

### Option 1: Pre-built container
```
singularity pull seqrepeatpuller.sif https://github.com/EwenBurban/SeqRepeatPuller/releases/download/v0.2/SeqRepeatPuller.sif
```

### Option 2: Build from source code
**Note:** Requires sudo privileges.
**Caution:** you might get unstable version 
```
git clone https://github.com/EwenBurban/SeqRepeatPuller.git
cd SeqRepeatPuller
sudo singularity build seqrepeatpuller.sif container.def
```

## Usage

/!\ WARNING : always use absolute pathways and so avoid relatives path in your config.yaml files

### Generate a position file (optional)
To generate a position file, provide the following files:
- `TE_refseq`: Sequence of the repeated element.
- `seq_bed`: BED file listing sequences of interest on the repeated elements. Ensure the first column contains the chromosome/contig names.
- `TE_bed`: BED file listing repeated elements of interest.
- `genome_ref`: Genome sequence of interest.

The resulting file is presented below at "Resulting files" section

Fill a `config.yaml` file with the information:
```
TE_refseq: path/to/your/file
seq_bed: path/to/your/file
TE_bed: path/to/your/file
genome_ref: path/to/your/file
```
Run the following command:
```
singularity exec seqrepeatpuller.sif get_WG_pos -c <config.yaml>
```
Or specify an output path:
```
singularity exec seqrepeatpuller.sif get_WG_pos -c <config.yaml> -w <output path>
```

#### Mapping behavior control
By default, `get_WG_pos` maps sequences in "end-to-end" mode. You can switch to "fragmented" mode, which generates fragments of the repeated element sequence using a sliding window process. Example `config.yaml` for fragmented mode:
```
TE_refseq: path/to/your/file
seq_bed: path/to/your/file
TE_bed: path/to/your/file
genome_ref: path/to/your/file
mode: fragmented
fragment_size: 200
fragment_step: 100
```

#### Cleaning
To clean the generated position file and remove gaps or duplicates, include the following in your `config.yaml`:
```
clean_xtracted_results: "True"
```

#### Resulting files
- **Position file (`wg_xtracted_position.xbed`):**
  Ensure custom files adhere to the following column naming convention:
  ```
  refName	refStart	refEnd	2Xtract_seq_tag	2Xtract_ref_seq
  chr1	47165943	47165945	CG_1:NM=546:AS=-2907:TE_POS=chr1:47165916-47172061(L1PA4)	CA
  ```

/!\  Please note that refStart and refEnd follow the bed file convention (refStart is 0-based and refEnd is 1-based)

- **Metadata file (`wg_xtracted_position_metadata.json`):**
  Includes reproducibility details and cleaning process statistics.
  ```
  {
      "file_name": "wg_xtracted_position_cleaned.xbed",
      "created_at": "2025-01-20T10:12:56.238509",
      "version (git commit)": "6a1e584",
      "aligner": "bowtie2",
      "genome of reference": "hg38.fa",
      "cleaning done": "True",
      "gappy positions removed": 3967,
      "duplicate positions removed": 2
  }
  ```

### Run SeqRepeatPuller

#### Option 1: Starting from a BAM file
Firstly create  a `config.yaml` file:
```
input_: path/to/your/BAM/files
pos_file: path/to/your/position/file
format_file: bam
```
Run:
```
singularity exec seqrepeatpuller.sif SeqRepeatPuller -c <config.yaml> -w <optional output path> -j <parallel tasks>
```

#### Option 2: Starting from a FASTQ file

##### Index the genome
Index the genome based on the selected aligner:
```
singularity exec seqrepeatpuller.sif index -i <reference genome> -a <aligner (bowtie2 or bismark)> -o <output path>
```

##### Create a `config.yaml` file
```
input_: path/to/your/FASTQ/files
pos_file: path/to/your/position/file
genome_folder: path/to/genome/index
aligner: bowtie2 (default) or bismark
format_file: fastq.gz
```
If using paired-end FASTQ files with non-standard naming conventions, specify:
```
read_naming: custom_naming_convention (e.g., _R1|_R2)
```
Run:
```
singularity exec seqrepeatpuller.sif SeqRepeatPuller -c <config.yaml> -w <optional output path> -j <parallel tasks>
```

## Troubleshooting
If you encounter any issues, please submit them on the GitHub issue tracker.

## TODO

- change the way meta data are included to be inside the file (# header) which suppose to add an argument in pandas.read_csv() to skip 

